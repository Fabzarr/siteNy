<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion du Menu - New York Caf√©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px 15px;
        }

        #categories-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            #categories-container {
                grid-template-columns: 1fr;
            }
            
            .dish-item {
                padding: 15px 10px;
            }
            
            .dish-order {
                position: static;
                display: inline-block;
                margin-bottom: 8px;
                width: auto;
            }
            
            .dish-price {
                position: static;
                display: inline-block;
                float: right;
                margin-bottom: 8px;
                font-size: 1.1em;
            }
            
            .dish-content {
                margin-left: 0;
                margin-right: 0;
                clear: both;
            }
            
            .dish-controls {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .dish-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .action-btn {
                flex: 1;
                min-width: 100px;
                font-size: 0.8em;
                padding: 8px 6px;
            }
            
            .order-controls {
                justify-content: center;
                margin-left: 0;
            }
            
            .dish-name {
                font-size: 1.1em;
                margin-bottom: 8px;
            }
            
            .dish-description {
                font-size: 0.9em;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-row .form-group {
                margin-bottom: 15px;
            }
        }

        .category-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
        }

        .category-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            position: relative;
        }

        .category-title {
            font-size: 1.5em;
            font-weight: bold !important;
            margin-bottom: 5px;
        }

        .category-header .category-title {
            font-weight: bold !important;
            font-size: 1.5em;
            margin-bottom: 5px;
            color: white;
        }

        .category-description {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .add-dish-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .add-dish-btn:hover {
            background: #219a52;
        }

        .dishes-list {
            padding: 20px;
        }

        .dish-item {
            display: block;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
            position: relative;
        }

        .dish-item:hover {
            background-color: #f8f9fa;
        }

        .dish-item:last-child {
            border-bottom: none;
        }

        .dish-order {
            position: absolute;
            top: 15px;
            left: 10px;
            font-weight: bold;
            color: #666;
            font-size: 1.1em;
            width: 30px;
        }

        .dish-price {
            position: absolute;
            top: 15px;
            right: 10px;
            font-weight: bold;
            color: #e74c3c;
            font-size: 1em;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 5px;
            border: 2px solid #e74c3c;
        }

        .dish-content {
            margin-left: 50px;
            margin-right: 100px;
            padding-right: 10px;
        }

        .dish-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dish-actions {
            display: flex;
            gap: 10px;
        }

        .order-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }

        .action-btn.edit:hover {
            background: #2980b9;
        }

        .action-btn.delete {
            background: #e74c3c;
        }

        .action-btn.delete:hover {
            background: #c0392b;
        }

        .action-btn.toggle {
            background: #f39c12;
        }

        .action-btn.toggle:hover {
            background: #e67e22;
        }

        .action-btn.unavailable {
            background: #95a5a6;
        }

        .action-btn.unavailable:hover {
            background: #7f8c8d;
        }

        .order-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            min-width: 30px;
        }

        .order-btn:hover {
            background: #2c3e50;
        }

        .order-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px 30px;
            border-radius: 10px 10px 0 0;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .empty-category {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-cancel {
            background: #95a5a6;
        }

        .btn-cancel:hover {
            background: #7f8c8d;
        }

        .unavailable {
            opacity: 0.6;
        }

        .unavailable .dish-name {
            text-decoration: line-through;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .dish-name {
            font-size: 1.1em;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .dish-description {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçΩÔ∏è Gestion du Menu - New York Caf√©</h1>
        <p>G√©rez vos plats par cat√©gorie</p>
        <div style="margin-top: 15px;">
            <button onclick="window.location.href='/admin-nyc-2024-secret/'" style="margin: 5px; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                ‚Üê Retour au Dashboard
            </button>
        </div>
    </div>

    <div class="container">
        <div id="messages"></div>
        <div id="categories-container">
            <!-- Les cat√©gories seront charg√©es ici -->
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un plat -->
    <div id="dishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">
                Ajouter un plat
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="dishForm">
                    <div class="form-group">
                        <label for="dishCategory">Cat√©gorie *</label>
                        <select id="dishCategory" name="categorie_id" required>
                            <!-- Les options seront remplies dynamiquement -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dishName" id="dishNameLabel">Nom du plat *</label>
                        <input type="text" id="dishName" name="nom" required>
                    </div>

                    <div class="form-group" id="normalFields">
                        <label for="dishDescription">Description</label>
                        <textarea id="dishDescription" name="description" placeholder="Description du plat..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dishPrice">Prix (‚Ç¨) *</label>
                            <input type="number" id="dishPrice" name="prix" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="dishPhoto">URL de la photo</label>
                            <input type="url" id="dishPhoto" name="photo_url" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let categories = [];
        let dishes = [];
        let currentDish = null;

        /*
        // Ancienne initialisation - remplac√©e par DOMContentLoaded
        loadData().then(() => {
            renderCategories();
            loadCategoryOptions();
        });
        */

        async function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return false;
            }

            try {
                const response = await fetch('/admin-nyc-2024-secret/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin-nyc-2024-secret/login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Erreur de v√©rification:', error);
                localStorage.removeItem('adminToken');
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return false;
            }
        }

        async function loadData() {
            try {
                const token = localStorage.getItem('adminToken');
                
                // Charger les cat√©gories
                const categoriesResponse = await fetch('/admin-nyc-2024-secret/api/admin/categories', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!categoriesResponse.ok) throw new Error('Erreur lors du chargement des cat√©gories');
                
                const categoriesData = await categoriesResponse.json();
                categories = categoriesData.categories;
                
                // Charger les plats
                const platsResponse = await fetch('/admin-nyc-2024-secret/api/admin/plats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!platsResponse.ok) throw new Error('Erreur lors du chargement des plats');
                
                const platsData = await platsResponse.json();
                dishes = platsData.plats;
                
                console.log('Donn√©es charg√©es:', { categories: categories.length, dishes: dishes.length });
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors du chargement des donn√©es', 'error');
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            categories.forEach(category => {
                // Filtrer les plats disponibles de cette cat√©gorie, en excluant la cat√©gorie vins
                if (category.slug === 'carte-des-vins') {
                    return; // Ne pas afficher la cat√©gorie vins
                }
                
                const categoryDishes = dishes.filter(dish => dish.categorie_id === category.id);
                
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.id = `category-${category.id}`;
                categorySection.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${category.nom}</div>
                        <button class="add-dish-btn" onclick="openAddDishModal(${category.id})">
                            ‚ûï Ajouter un plat
                        </button>
                    </div>
                    <div class="dishes-list">
                        ${categoryDishes.length > 0 ? 
                            categoryDishes
                                .sort((a, b) => (a.ordre_affichage || 0) - (b.ordre_affichage || 0))
                                .map(dish => renderDish(dish, category))
                                .join('') 
                            : '<div class="empty-category">Aucun plat dans cette cat√©gorie</div>'
                        }
                    </div>
                `;
                
                container.appendChild(categorySection);
            });
        }

        function renderSingleCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category || category.slug === 'carte-des-vins') return;

            const categoryDishes = dishes.filter(dish => dish.categorie_id === categoryId);
            const categoryElement = document.getElementById(`category-${categoryId}`);
            
            if (categoryElement) {
                const dishesListElement = categoryElement.querySelector('.dishes-list');
                if (dishesListElement) {
                    dishesListElement.innerHTML = categoryDishes.length > 0 ? 
                        categoryDishes
                            .sort((a, b) => (a.ordre_affichage || 0) - (b.ordre_affichage || 0))
                            .map(dish => renderDish(dish, category))
                            .join('') 
                        : '<div class="empty-category">Aucun plat dans cette cat√©gorie</div>';
                }
            }
        }

        function renderDish(dish, category) {
            const disponibleClass = dish.disponible ? '' : 'dish-unavailable';
            const dishClasses = `${disponibleClass}`;
            
            return `
                <div class="dish-item ${dishClasses}" data-dish-id="${dish.id}">
                    <div class="dish-order">${dish.ordre_affichage || ''}</div>
                    <div class="dish-price">${dish.prix} ‚Ç¨</div>
                    <div class="dish-content">
                        <div class="dish-name">${dish.nom}</div>
                        <div class="dish-description">${dish.description || ''}</div>
                        <div class="dish-controls">
                            <div class="dish-actions">
                                <button class="action-btn edit" onclick="editDish(${dish.id})" title="Modifier">
                                    Modifier
                                </button>
                                <button class="action-btn delete" onclick="deleteDish(${dish.id}, '${dish.nom}')" title="Supprimer">
                                    Supprimer
                                </button>
                                <button class="action-btn ${dish.disponible ? 'toggle' : 'unavailable'}" 
                                        onclick="toggleDishAvailability(${dish.id})" 
                                        title="${dish.disponible ? 'Rendre indisponible' : 'Rendre disponible'}">
                                    ${dish.disponible ? 'Indisponible' : 'Disponible'}
                                </button>
                            </div>
                            <div class="order-controls">
                                <button class="order-btn" onclick="moveDish(${dish.id}, 'up')" title="Monter">‚Üë</button>
                                <button class="order-btn" onclick="moveDish(${dish.id}, 'down')" title="Descendre">‚Üì</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadCategoryOptions() {
            const categorySelect = document.getElementById('dishCategory');
            categorySelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie</option>';
            
            categories.forEach(category => {
                // Exclure la cat√©gorie vins
                if (category.slug === 'carte-des-vins') {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.nom;
                categorySelect.appendChild(option);
            });
        }

        function openAddDishModal(categoryId) {
            currentDish = null;
            document.getElementById('modalTitle').textContent = 'Ajouter un plat';
            document.getElementById('dishForm').reset();
            
            if (categoryId) {
                document.getElementById('dishCategory').value = categoryId;
            }
            
            document.getElementById('dishModal').style.display = 'block';
        }

        function editDish(dishId) {
            const dish = dishes.find(d => d.id === dishId);
            if (!dish) return;
            
            currentDish = dish;
            
            // Remplir le formulaire
            document.getElementById('modalTitle').textContent = 'Modifier un plat';
            document.getElementById('dishName').value = dish.nom || '';
            document.getElementById('dishDescription').value = dish.description || '';
            document.getElementById('dishPrice').value = dish.prix || '';
            document.getElementById('dishCategory').value = dish.categorie_id || '';
            document.getElementById('dishPhoto').value = dish.photo_url || '';
            
            document.getElementById('dishModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dishModal').style.display = 'none';
            currentDish = null;
        }

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('dishModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        document.getElementById('dishForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            await submitDish();
        });

        async function submitDish() {
            const form = document.getElementById('dishForm');
            const formData = new FormData(form);
            
            // Validation de base
            if (!formData.get('nom') || !formData.get('prix') || !formData.get('categorie_id')) {
                showMessage('Veuillez remplir tous les champs obligatoires.', 'error');
                return;
            }

            const token = localStorage.getItem('adminToken');
            if (!token) {
                showMessage('Erreur: Token d\'authentification manquant', 'error');
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return;
            }

            // Pr√©parer les donn√©es
            const dishData = {
                nom: formData.get('nom'),
                description: formData.get('description'),
                prix: parseFloat(formData.get('prix')),
                categorie_id: parseInt(formData.get('categorie_id')),
                photo_url: formData.get('photo_url') || null
            };

            try {
                const url = currentDish ? `/admin-nyc-2024-secret/api/admin/plats/${currentDish.id}` : '/admin-nyc-2024-secret/api/admin/plats';
                const method = currentDish ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dishData)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    const action = currentDish ? 'modifi√©' : 'ajout√©';
                    
                    if (currentDish) {
                        // Mise √† jour d'un plat existant - mettre √† jour les donn√©es locales
                        const dishIndex = dishes.findIndex(d => d.id === currentDish.id);
                        if (dishIndex !== -1) {
                            dishes[dishIndex] = { ...dishes[dishIndex], ...dishData, id: currentDish.id };
                        }
                    } else {
                        // Nouveau plat - l'ajouter aux donn√©es locales
                        const newDish = { ...dishData, id: responseData.plat.id, disponible: true, ordre_affichage: responseData.plat.ordre_affichage };
                        dishes.push(newDish);
                    }
                    
                    // Re-rendre seulement la cat√©gorie concern√©e
                    renderSingleCategory(dishData.categorie_id);
                    
                    showMessage(`‚úì Plat ${action} avec succ√®s !`, 'success');
                    closeModal();
                } else {
                    const error = await response.text();
                    showMessage('Erreur lors de la sauvegarde : ' + error, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur de connexion', 'error');
            }
        }

        async function toggleDishAvailability(dishId) {
            const dish = dishes.find(d => d.id === dishId);
            if (!dish) return;

            const token = localStorage.getItem('adminToken');
            if (!token) {
                showMessage('Erreur: Token d\'authentification manquant', 'error');
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return;
            }

            // Feedback visuel imm√©diat
            const dishElement = document.querySelector(`[data-dish-id="${dishId}"]`);
            if (dishElement) {
                dishElement.style.opacity = '0.5';
            }

            try {
                const response = await fetch(`/admin-nyc-2024-secret/api/admin/plats/${dishId}/toggle-disponibilite`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Mettre √† jour les donn√©es locales
                    dish.disponible = !dish.disponible;
                    
                    // Re-rendre seulement cette cat√©gorie
                    renderSingleCategory(dish.categorie_id);
                    
                    const message = dish.disponible ? '‚úì Plat affich√©' : '‚úì Plat masqu√©';
                    showMessage(message, 'success');
                } else {
                    const error = await response.text();
                    showMessage('Erreur lors de la modification : ' + error, 'error');
                    
                    // Restaurer l'opacit√© en cas d'erreur
                    if (dishElement) {
                        dishElement.style.opacity = '1';
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur de connexion', 'error');
                
                // Restaurer l'opacit√© en cas d'erreur
                if (dishElement) {
                    dishElement.style.opacity = '1';
                }
            }
        }

        async function deleteDish(dishId, dishName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${dishName}" ?`)) return;

            const token = localStorage.getItem('adminToken');
            if (!token) {
                showMessage('Erreur: Token d\'authentification manquant', 'error');
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return;
            }

            const dish = dishes.find(d => d.id === dishId);
            const categoryId = dish ? dish.categorie_id : null;

            // Feedback visuel imm√©diat
            const dishElement = document.querySelector(`[data-dish-id="${dishId}"]`);
            if (dishElement) {
                dishElement.style.opacity = '0.3';
                dishElement.style.pointerEvents = 'none';
            }

            try {
                const response = await fetch(`/admin-nyc-2024-secret/api/admin/plats/${dishId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Supprimer des donn√©es locales
                    const dishIndex = dishes.findIndex(d => d.id === dishId);
                    if (dishIndex !== -1) {
                        dishes.splice(dishIndex, 1);
                    }
                    
                    // Re-rendre seulement cette cat√©gorie
                    if (categoryId) {
                        renderSingleCategory(categoryId);
                    }
                    
                    showMessage('‚úì Plat supprim√©', 'success');
                } else {
                    const error = await response.text();
                    showMessage('Erreur lors de la suppression : ' + error, 'error');
                    
                    // Restaurer l'√©tat en cas d'erreur
                    if (dishElement) {
                        dishElement.style.opacity = '1';
                        dishElement.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur de connexion', 'error');
                
                // Restaurer l'√©tat en cas d'erreur
                if (dishElement) {
                    dishElement.style.opacity = '1';
                    dishElement.style.pointerEvents = 'auto';
                }
            }
        }

        async function moveDish(dishId, direction) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showMessage('Erreur: Token d\'authentification manquant', 'error');
                window.location.href = '/admin-nyc-2024-secret/login.html';
                return;
            }

            // Trouver le plat √† d√©placer
            const dishToMove = dishes.find(d => d.id === dishId);
            if (!dishToMove) return;

            // Filtrer les plats de la m√™me cat√©gorie et les trier par ordre
            const categoryDishes = dishes
                .filter(d => d.categorie_id === dishToMove.categorie_id)
                .sort((a, b) => (a.ordre_affichage || 0) - (b.ordre_affichage || 0));

            const currentIndex = categoryDishes.findIndex(d => d.id === dishId);
            
            // V√©rifier si le d√©placement est possible
            if ((direction === 'up' && currentIndex === 0) || 
                (direction === 'down' && currentIndex === categoryDishes.length - 1)) {
                return; // Pas de d√©placement possible
            }

            // Feedback visuel imm√©diat - d√©sactiver les boutons temporairement
            const dishElement = document.querySelector(`[data-dish-id="${dishId}"]`);
            if (dishElement) {
                const buttons = dishElement.querySelectorAll('.order-btn');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });
            }

            try {
                const endpoint = direction === 'up' ? 'move-up' : 'move-down';
                const response = await fetch(`/admin-nyc-2024-secret/api/admin/plats/${dishId}/${endpoint}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Mise √† jour optimis√©e : ne recharger que l'ordre des plats de cette cat√©gorie
                    const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                    const targetDish = categoryDishes[targetIndex];

                    // √âchanger les ordres dans les donn√©es locales
                    const tempOrder = dishToMove.ordre_affichage;
                    dishToMove.ordre_affichage = targetDish.ordre_affichage;
                    targetDish.ordre_affichage = tempOrder;

                    // Re-rendre seulement cette cat√©gorie
                    renderSingleCategory(dishToMove.categorie_id);
                    
                    // Message de succ√®s plus discret
                    showMessage('‚úì Ordre modifi√©', 'success');
                } else {
                    const error = await response.text();
                    showMessage('Erreur lors du d√©placement : ' + error, 'error');
                    
                    // R√©activer les boutons en cas d'erreur
                    if (dishElement) {
                        const buttons = dishElement.querySelectorAll('.order-btn');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        });
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur de connexion', 'error');
                
                // R√©activer les boutons en cas d'erreur
                if (dishElement) {
                    const buttons = dishElement.querySelectorAll('.order-btn');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }
            }
        }

        function showMessage(text, type) {
            // Cr√©er ou r√©cup√©rer le conteneur de messages
            let messagesDiv = document.getElementById('messages');
            if (!messagesDiv) {
                messagesDiv = document.createElement('div');
                messagesDiv.id = 'messages';
                messagesDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 300px;
                `;
                document.body.appendChild(messagesDiv);
            }

            const messageDiv = document.createElement('div');
            const isSuccess = type === 'success';
            
            messageDiv.style.cssText = `
                padding: ${isSuccess ? '8px 12px' : '15px'};
                margin: 10px 0;
                border-radius: 5px;
                font-weight: ${isSuccess ? 'normal' : 'bold'};
                font-size: ${isSuccess ? '0.9em' : '1em'};
                transition: all 0.3s ease;
                ${isSuccess ? 
                    'background: rgba(212, 237, 218, 0.9); color: #155724; border: 1px solid #c3e6cb;' : 
                    'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                }
            `;
            messageDiv.textContent = text;
            
            messagesDiv.appendChild(messageDiv);
            
            // Animation d'entr√©e
            requestAnimationFrame(() => {
                messageDiv.style.transform = 'translateX(0)';
                messageDiv.style.opacity = '1';
            });
            
            // Disparition plus rapide pour les messages de succ√®s
            const duration = isSuccess ? 2000 : 5000;
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 300);
            }, duration);
        }

        // Initialisation au chargement de la page
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadData();
                renderCategories();
                loadCategoryOptions();
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                showMessage('Erreur lors du chargement de la page', 'error');
            }
        });
    </script>
</body>
</html>